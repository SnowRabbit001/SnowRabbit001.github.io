<!DOCTYPE html>
<html>
 
<head>
    <meta charset="utf-8">
    <!-- <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script> -->
    <title>code39_test0</title>
</head>
 
<body>
    <video id="video" width="400" height="400" autoplay></video>
    <button id="snap">Snap Photo</button>
    <canvas id="canvas" width="400" height="400"></canvas>
</body>

<script>
    var video = document.getElementById('video');
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
 
    navigator.getUserMedia = navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia; //获取媒体对象（这里指摄像头）
    navigator.getUserMedia({
        video: true
    }, gotStream, noStream); //参数1获取用户打开权限；参数二是一个回调函数，自动传入视屏流，成功后调用，并传一个视频流对象，参数三打开失败后调用，传错误信息
 
    function gotStream(stream) {
  
       // video.src = URL.createObjectURL(stream); // 老写法
        video.srcObject = stream;
      
        video.onerror = function() {
            stream.stop();
        };
        stream.onended = noStream;
        video.onloadedmetadata = function() {
            // alert('攝像頭成功打開');
        };
    }
 
    function noStream(err) {
        alert(err);
    }
 
    document.getElementById("snap").addEventListener("click", function() {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height); //将获取视频绘制在画布上
        toGray();
        toBinarization();
    });

    function toGray() {
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);//取出影像資料陣列
        console.log(imageData);
        const imageBuffer = imageData.data;
        console.log(imageBuffer);

        for(var i = 0; i<imageBuffer.length; i+=4) {
            // 在imageBuffer之中每4個元素分別代表著每個像素的red, green, blue, alpha數值(0 ~ 255)
            red   = imageBuffer[i];
            green = imageBuffer[i + 1];
            blue  = imageBuffer[i + 2];
            alpha = imageBuffer[i + 3];
            // 將畫布中每個像素的rgb值設定為rgb平均值，能使圖片灰階化
            arg = (red + green + blue) / 3;
            imageBuffer[i] = arg ;
            imageBuffer[i + 1] = arg;
            imageBuffer[i + 2] = arg;
            imageBuffer[i + 3] = alpha;
        }
        ctx.putImageData(imageData, 0, 0);//繪製影像陣列到畫布上
        document.body.appendChild(canvas);
    }

    function toBinarization() {
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);//取出影像資料陣列
        console.log(imageData);
        const imageBuffer = imageData.data;
        console.log(imageBuffer);

        for(var i = 0; i<imageBuffer.length; i+=4) {
            // 在imageBuffer之中每4個元素分別代表著每個像素的red, green, blue, alpha數值(0 ~ 255)
            red   = imageBuffer[i];
            green = imageBuffer[i + 1];
            blue  = imageBuffer[i + 2];
            alpha = imageBuffer[i + 3];
            // 將畫布中每個像素的rgb值設定為rgb平均值，能使圖片二值化
            arg = (((red + green + blue) / 3) > 180) ? 255 : 0;//255=白; 0=黑
            imageBuffer[i] = arg ;
            imageBuffer[i + 1] = arg;
            imageBuffer[i + 2] = arg;
            imageBuffer[i + 3] = alpha;
        }
        ctx.putImageData(imageData, 0, 0);//繪製影像陣列到畫布上
        document.body.appendChild(canvas);
    }
</script>
 
</html>